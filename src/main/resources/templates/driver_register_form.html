<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Driver Registration</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link rel="stylesheet" th:href="@{/style.css}" />
</head>
<body>
    <h2 style="margin-top: 100px;">Become a Driver</h2>
    <p>Please fill in your vehicle details and upload documents.</p>
    
    
<form id="register-form" method="post" action="/driver/register">
    <input type="hidden" name="initData" id="initDataHidden">

    <label for="carModel">Car Model:</label>
    <input type="text" id="carModel" name="carModel" required><br>

    <label for="carModel">Car Сolor:</label>
    <input type="text" id="carColor" name="carColor" required><br>
    
    <label for="licensePlate">License Plate:</label>
    <input type="text" id="licensePlate" name="licensePlate" required><br>

    <label for="driverLicenseUrl">Driver License URL:</label>
    <input type="url" id="driverLicenseUrl" name="driverLicenseUrl" required><br>

    <label for="carRegistrationUrl">Car Registration URL:</label>
    <input type="url" id="carRegistrationUrl" name="carRegistrationUrl" required><br>

    <button type="submit" class="submit-btn btn">Register</button>
</form>

    
    <div id="debugLog" style="white-space: pre; background: #f0f0f0; padding: 10px; margin-top: 20px; font-size: 12px;"></div>
    
 <script>
document.addEventListener('DOMContentLoaded', () => {
    Telegram.WebApp.ready();

    function getInitDataFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('initData') || '';
    }

    const initData = getInitDataFromURL();

    if (!initData) {
        alert('initData missing in URL');
        return;
    }

    // Записываем initData в скрытое поле формы
    document.getElementById('initDataHidden').value = initData;

    const userData = Telegram.WebApp.initDataUnsafe?.user;

    if (!userData) {
        alert('User data not received');
        return;
    }

    const formElement = document.getElementById('register-form');

    formElement.addEventListener('submit', async (event) => {
        event.preventDefault();

        // Собираем данные формы в объект
        const formData = new FormData(formElement);
        const driverData = Object.fromEntries(formData.entries());

        // Добавляем telegramId и fullName из Telegram SDK (не из формы)
        driverData.telegramId = userData.id;
        driverData.fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim();

        try {
            const response = await fetch('https://alpha-multispinous-outbully.ngrok-free.dev/api/drivers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Telegram-Init-Data': initData
                },
                body: JSON.stringify(driverData)
            });

            if (response.ok) {
                alert('Success!');
                window.location.href = `/driver/dashboard?initData=${encodeURIComponent(initData)}`;
            } else {
                const errorText = await response.text();
                alert('Registration Error: ' + errorText);
            }
        } catch (error) {
            alert('Network Error: ' + error);
        }
    });
});
</script>



</body>
</html>