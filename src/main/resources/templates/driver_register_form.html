<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Driver Registration | Hop-in</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="stylesheet" th:href="@{/style.css}" />
    <style>
        :root {
            --tg-theme-bg-color: #fff;
            --tg-theme-text-color: #000;
            --tg-theme-button-color: #007aff;
            --tg-theme-button-text-color: #ffffff;
        }

        body {
            margin: 0;
            padding: calc(env(safe-area-inset-top, 0px) + 60px) 20px env(safe-area-inset-bottom, 20px);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
        }

        h2 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 24px;
            font-weight: 700;
        }

        p {
            margin-bottom: 25px;
            opacity: 0.7;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 13px;
            color: var(--tg-theme-button-color);
        }

        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 16px;
            background: #f9f9f9;
        }

        input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color);
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            cursor: pointer;
        }

        #debugLog {
            display: none; 
        }
    </style>
</head>
<body>
    <h2>Become a Driver</h2>
    <p>Please fill in your vehicle details and upload documents.</p>
    
    <form id="register-form" method="post" action="/driver/register">
        <input type="hidden" name="initData" id="initDataHidden">

        <div class="form-group">
            <label for="carModel">Car Model</label>
            <input type="text" id="carModel" name="carModel" placeholder="e.g. Toyota Prius" required>
        </div>

        <div class="form-group">
            <label for="carColor">Car Color</label>
            <input type="text" id="carColor" name="carColor" placeholder="e.g. White" required>
        </div>
        
        <div class="form-group">
            <label for="licensePlate">License Plate</label>
            <input type="text" id="licensePlate" name="licensePlate" placeholder="AA 1234 BB" required>
        </div>

        <div class="form-group">
            <label for="driverLicenseUrl">Driver License URL (Image/PDF)</label>
            <input type="url" id="driverLicenseUrl" name="driverLicenseUrl" placeholder="https://..." required>
        </div>

        <div class="form-group">
            <label for="carRegistrationUrl">Car Registration URL (Image/PDF)</label>
            <input type="url" id="carRegistrationUrl" name="carRegistrationUrl" placeholder="https://..." required>
        </div>

        <button type="submit" class="submit-btn">Register</button>
    </form>

    
 <div id="debugLog" style="white-space: pre; background: #f0f0f0; padding: 10px; margin-top: 20px; font-size: 12px;"></div>
    
 <script>
document.addEventListener('DOMContentLoaded', () => {
	const tg = Telegram.WebApp;
    tg.ready();
    tg.expand();

    
 	// --- Data Initialization ---
    // Try to get initData from Telegram first, then from URL
    const initData = tg.initData || new URLSearchParams(window.location.search).get('initData') || '';
    const userData = tg.initDataUnsafe?.user;
    const formElement = document.getElementById('register-form');
    
    if (!initData) {
        tg.showAlert('Error: Authentication data (initData) is missing.');
        return;
    }
    
    if (!userData) {
        tg.showAlert('Error: Unable to retrieve your Telegram profile.');
        return;
    }
    
 	// Fill the hidden field if it exists
    const hiddenInput = document.getElementById('initDataHidden');
    if (hiddenInput) hiddenInput.value = initData;
    
 	// --- Registration Logic ---
    formElement.addEventListener('submit', async (event) => {
        event.preventDefault();

        const formData = new FormData(formElement);
        const driverData = Object.fromEntries(formData.entries());

        // Fill driver data from Telegram profile
        driverData.telegramId = userData.id;
        driverData.fullName = `${userData.first_name || ''} ${userData.last_name || ''}`.trim();

        try {
            const response = await fetch('/api/drivers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Telegram-Init-Data': initData
                },
                body: JSON.stringify(driverData)
            });

            if (response.ok) {
                // Success vibration
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('success');
                }

                tg.showAlert('Registration successful! Welcome to the team.', () => {
                    window.location.href = `/driver/dashboard?initData=${encodeURIComponent(initData)}`;
                });
            } else {
                const errorText = await response.text();
                tg.showAlert('Registration Failed: ' + errorText);
            }
        } catch (error) {
            console.error('Registration network error:', error);
            tg.showAlert('Network Error. Please check your connection and try again.');
        }
    });
});
</script>

</body>
</html>