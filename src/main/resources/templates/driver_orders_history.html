<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Driver Orders History | Hop-in taxi app</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" th:href="@{/style.css}"/>
</head>
<body>

<div class="header">
    <h1>Orders History</h1>
</div>

<div class="orders-container" id="driver-orders-list">
    <div class="loading">Loading orders...</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    
    let initData = tg.initData || new URLSearchParams(window.location.search).get('initData') || '';
    const ordersList = document.getElementById('driver-orders-list');

    function formatDate(datetime) {
        if (!datetime) return 'N/A';
        const options = {
            day: '2-digit',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        return new Date(datetime).toLocaleString('en-US', options);
    }

    async function loadDriverHistory() {
        if (!initData) {
            ordersList.innerHTML = '<div class="error">Error: Unauthorized access.</div>';
            return;
        }

        try {
            const response = await fetch('/api/orders/driver-history', {
                method: 'GET',
                headers: {
                    'X-Telegram-Init-Data': initData
                }
            });

            if (!response.ok) {
                throw new Error('Could not fetch history');
            }

            const orders = await response.json();
            renderOrders(orders);
        } catch (err) {
            console.error('History load error:', err);
            ordersList.innerHTML = `<div class="error">Failed to load trip history.</div>`;
        }
    }

    function renderOrders(orders) {
        if (!ordersList) return;
        ordersList.innerHTML = '';

        if (orders.length === 0) {
            ordersList.innerHTML = '<div class="empty">No trip history yet.</div>';
            return;
        }

        orders.forEach(order => {
            const card = document.createElement('div');
            card.className = 'order-card';

            const dateFormatted = formatDate(order.finishedAt || order.createdAt);
            const status = (order.status || 'UNKNOWN').toUpperCase();
            
            const isCompleted = status === 'COMPLETED' || status === 'FINISHED';
            const isCanceled = status === 'CANCELED' || status === 'CANCELLED' || status === 'CANCEL_BY_DRIVER';

            // --- Stats Block (Duration & Distance) ---
            let statsBlock = '';
            if (isCompleted) {
                const duration = order.actualDuration ? `${Math.round(order.actualDuration)} min` : 'N/A';
                const distance = order.aproximateDistance ? `${order.aproximateDistance.toFixed(1)} km` : 'N/A';
                statsBlock = `
                    <div class="order-stats">
                        <span>‚è± ${duration} (${distance})</span>
                    </div>
                `;
            }

         	// --- Price & Status Block ---
            let priceBlock;
            if (isCompleted) {
                const total = order.totalPrice ? order.totalPrice.toFixed(2) : '0.00';
                
                const tip = (order.bonusFare && order.bonusFare > 0) 
                    ? `<span class="bonus">(incl. tip: ${order.bonusFare.toFixed(2)})</span>` 
                    : '';
                
                priceBlock = `<div class="order-price"><strong>Total:</strong> ${total} ${tip}</div>`;
            } else if (isCanceled) {
                priceBlock = `<div class="order-price no-price">Trip cancelled</div>`;
            } else {
                priceBlock = `<div class="order-price no-price">Status: ${status}</div>`;
            }

            card.innerHTML = `
                <div class="order-header">
                    <span class="order-date">${dateFormatted}</span>
                    <span class="order-status status-${status.toLowerCase()}">${status}</span>
                </div>
                <hr>
                <div class="order-address"><strong>From:</strong> ${order.startAddress}</div>
                <div class="order-address"><strong>To:</strong> ${order.endAddress}</div>
                ${order.notes ? `<div class="order-notes">Client's notes: ${order.notes}</div>` : ''}
                ${statsBlock}
                ${priceBlock}
            `;

            ordersList.appendChild(card);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        tg.ready();

        // Configure Back Button
        tg.BackButton.show();
        tg.BackButton.onClick(() => {
            window.location.href = '/driver/dashboard?initData=' + encodeURIComponent(initData);
        });

        loadDriverHistory();
    });
</script>

</body>
</html>