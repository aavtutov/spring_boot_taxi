<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Driver Orders History | Hop-in taxi app</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" th:href="@{/style.css}"/>
</head>
<body>

<div class="header">
    <h1>Orders History</h1>
</div>

<div class="orders-container" id="driver-orders-list">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–µ–∑–¥–æ–∫...</div>
</div>

<script>
    // 1. –ü–æ–ª—É—á–µ–Ω–∏–µ initData –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ URL
    function getInitDataFromUrl() {
        const params = new URLSearchParams(window.location.search);
        // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ initData –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∫–∞–∫ /driver-history.html?initData=...
        return params.get('initData') || '';
    }

    let initData = getInitDataFromUrl();
    const ordersList = document.getElementById('driver-orders-list');

    if (!initData) {
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ Telegram WebApp –≤—Å–µ –∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω
        const webAppInitData = Telegram.WebApp?.initData || Telegram.WebApp?.initDataUnsafe || '';
        if (webAppInitData) {
            console.warn('InitData not in URL, using Telegram WebApp data.');
            initData = webAppInitData;
        } else {
            ordersList.innerHTML = '<div class="error">–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telegram (initData).</div>';
        }
    }

    function formatDate(datetime) {
        const options = {
            day: '2-digit',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º 'ru-RU' –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.
        // –ò–ª–∏ 'en-US', –∫–∞–∫ –≤ –≤–∞—à–µ–º –ø—Ä–∏–º–µ—Ä–µ.
        return new Date(datetime).toLocaleString('en-US', options);
    }

    async function loadDriverHistory() {
        if (!initData) return; // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –ø—Ä–µ—Ä—ã–≤–∞–µ–º.

        try {
            // –ò–ó–ú–ï–ù–ï–ù–ê –∫–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ API –Ω–∞ /api/orders/driver-history
            const response = await fetch('/api/orders/driver-history', {
                method: 'GET',
                headers: {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º initData –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤–æ–¥–∏—Ç–µ–ª—è
                    'X-Telegram-Init-Data': initData
                }
            });

            if (!response.ok) {
                // –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç—å –æ—à–∏–±–∫—É —Å —Å–µ—Ä–≤–µ—Ä–∞
                const errorText = await response.text();
                throw new Error(`Failed to load driver history. Status: ${response.status}. Details: ${errorText}`);
            }

            const orders = await response.json();
            renderOrders(orders);
        } catch (err) {
            console.error('Error loading driver history:', err);
            ordersList.innerHTML = `<div class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–æ–µ–∑–¥–æ–∫. ${err.message}</div>`;
        }
    }

    function renderOrders(orders) {
        ordersList.innerHTML = '';

        if (orders.length === 0) {
            ordersList.innerHTML = '<div class="empty">No history yet.</div>';
            return;
        }

        orders.forEach(order => {
            const card = document.createElement('div');
            card.className = 'order-card';

            const dateFormatted = formatDate(order.finishedAt || order.createdAt || Date.now());

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            const status = (order.status || '').toUpperCase();
            const isCanceled = status === 'CANCELED';
            // –í–∫–ª—é—á–∞–µ–º FINISHED –∏ COMPLETED –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ
            const isCompleted = status === 'COMPLETED' || status === 'FINISHED';

            // --- –ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ) ---
            let statsBlock = '';
            if (isCompleted) {
                // –ò–°–ü–û–õ–¨–ó–£–ï–ú camelCase (actualDuration)
                const duration = order.actualDuration ? `${Math.round(order.actualDuration)} –º–∏–Ω` : 'N/A';
                // –ò–°–ü–û–õ–¨–ó–£–ï–ú camelCase –∏ –æ–ø–µ—á–∞—Ç–∫—É (aproximateDistance)
                const distance = order.aproximateDistance ? `${(order.aproximateDistance).toFixed(1)} –∫–º` : 'N/A';

                statsBlock = `
                <div class="order-stats">
                    <span>${duration} (~${distance})</span>
                </div>
            `;
            }


            // --- –ë–ª–æ–∫ –¶–µ–Ω—ã ---
            let priceBlock;
            if (isCompleted) {
                // –ï—Å–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º Total
                priceBlock = `<div class="order-price"><strong>Total:</strong> ${order.totalPrice || 'N/A'}</div>`;
            } else if (isCanceled) {
                // –ï—Å–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–û—Ç–º–µ–Ω–µ–Ω–æ"
                priceBlock = `<div class="order-price no-price"> Trip cancelled </div>`;
            } else {
                // –ï—Å–ª–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∏–ª–∏ –æ–∂–∏–¥–∞–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–∏—Ä–µ
                priceBlock = `<div class="order-price no-price"> In progress... </div>`;
            }


            card.innerHTML = `
            <div class="order-header">
                <span class="order-date">${dateFormatted}</span>
                <span class="order-status">${order.status || 'N/A'}</span>
            </div>
            <hr>

            
            <div class="order-address"><strong>‚è§</strong> ${order.startAddress}</div>
            <div class="order-address"><strong>‚è§</strong> ${order.endAddress}</div>
            ${order.notes ? `<div class="order-notes">üìå –ó–∞–º–µ—Ç–∫–∏: ${order.notes}</div>` : ''}
            ${statsBlock}
            ${priceBlock}
        `;

            ordersList.appendChild(card);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        if (Telegram.WebApp) {
            Telegram.WebApp.ready();

            // 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
            Telegram.WebApp.BackButton.show();
            Telegram.WebApp.BackButton.onClick(() => {
                // –í–æ–∑–≤—Ä–∞—Ç –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É, –ø–µ—Ä–µ–¥–∞–≤–∞—è initData –æ–±—Ä–∞—Ç–Ω–æ
                window.location.href = '/driver/dashboard?initData=' + encodeURIComponent(initData);
            });
        }


        // 4. –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
        loadDriverHistory();
    });
</script>

</body>
</html>