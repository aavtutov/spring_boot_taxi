<!--suppress XmlInvalidNamespace -->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Available Orders</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" th:href="@{/style.css}"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>
<body>

<div class="header">
    <h1>New Orders</h1>
    <div style="position: relative; display:block; top: 10px; text-align:center;">
        <button class="btn btn-additional" onclick="goToActives()">to active ‚Üí</button>
    </div>
</div>

<div class="orders-container" id="available-orders-list">
    <div class="loading">Loading orders...</div>
</div>

<script>
    const HEARTBEAT_INTERVAL = 30000;
    let heartbeatTimer = null;

    const initData = Telegram.WebApp?.initData || Telegram.WebApp?.initDataUnsafe || '';
    const ordersList = document.getElementById('available-orders-list');

    if (!initData) {
        alert('–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram.');
    }

    async function sendHeartbeat() {
        try {
            await fetch('/api/drivers/heartbeat', {
                method: 'POST',
                headers: {
                    'X-Telegram-Init-Data': initData
                }
            });
        } catch (error) {
            console.error('Heartbeat error:', error);
            stopHeartbeat();
        }
    }

    function startHeartbeat() {
        if (heartbeatTimer) return;
        sendHeartbeat();
        heartbeatTimer = setInterval(sendHeartbeat, HEARTBEAT_INTERVAL);
    }

    function stopHeartbeat() {
        clearInterval(heartbeatTimer);
        heartbeatTimer = null;
    }

    function formatDate(datetime) {
        const options = {
            day: '2-digit',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        return new Date(datetime).toLocaleString('en-EN', options);
    }

    async function loadAvailableOrders() {
        try {
            const response = await fetch('/api/orders', {
                method: 'GET',
                headers: {
                    'X-Telegram-Init-Data': initData
                }
            });

            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤');

            const orders = await response.json();
            renderOrders(orders);
        } catch (err) {
            console.error('Load available orders error:', err);
            ordersList.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</div>';
        }
    }

    function renderOrders(orders) {
        ordersList.innerHTML = '';

        if (orders.length === 0) {
            ordersList.innerHTML = '<div class="empty">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>';
            return;
        }

        orders.forEach(order => {
            const card = document.createElement('div');
            card.className = 'order-card';

            const dateFormatted = formatDate(order.createdAt || order.date || Date.now());

            const priceTotal = order.price + (order.bonusFare || 0);

            card.innerHTML = `
            <div class="order-header">
                <span class="order-date">${dateFormatted}</span>
            </div>
            <hr>
            <div class="order-address"><strong>‚è§</strong> ${order.startAddress}</div>
            <div class="order-address"><strong>‚è§</strong> ${order.endAddress}</div>
            ${order.notes ? `<div class="order-notes">üìå ${order.notes}</div>` : ''}
            <div class="order-price">
                <strong>Total:</strong> ${priceTotal} 
                ${order.bonusFare ? `<span class="bonus">(includes client's tip: ${order.bonusFare})</span>` : ''}
            </div>
            <button class="btn btn-blue" data-order-id="${order.id}">–ü—Ä–∏–Ω—è—Ç—å</button>
        `;

            card.querySelector('button').addEventListener('click', () => acceptOrder(order.id));
            ordersList.appendChild(card);
        });
    }

    async function acceptOrder(orderId) {
        try {
            const response = await fetch(`/api/orders/${orderId}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Telegram-Init-Data': initData
                },
                body: JSON.stringify({action: 'ACCEPT'})
            });

            if (!response.ok) {
                const errorText = await response.text();
                alert('–û—à–∏–±–∫–∞: ' + errorText);
                return;
            }

            const order = await response.json();
            alert(`–í—ã –ø—Ä–∏–Ω—è–ª–∏ –∑–∞–∫–∞–∑ #${order.id}`);
            window.location.href = `/driver/active-order?initData=${encodeURIComponent(initData)}`;
        } catch (err) {
            alert('–°–µ—Ç—å: –æ—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–∫–∞–∑–∞');
        }
    }

    function goToActives() {
        window.location.href = `/driver/active-order?initData=${encodeURIComponent(initData)}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
        Telegram.WebApp.ready();

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "Back"
        Telegram.WebApp.BackButton.show();
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
        Telegram.WebApp.BackButton.onClick(() => {
            window.location.href = `/index.html?initData=${encodeURIComponent(initData)}`;
        });

        startHeartbeat();
        loadAvailableOrders();
    });
</script>

</body>
</html>
