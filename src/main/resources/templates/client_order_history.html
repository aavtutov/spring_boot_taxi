<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Ride History | Hop-in taxi app</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" th:href="@{/style.css}"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
</head>
<body>

<div class="header">
    <h1>Ride History</h1>
</div>

<div class="orders-container" id="available-orders-list">
    <div class="loading">Loading orders...</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    const initData = tg.initData || new URLSearchParams(window.location.search).get('initData') || '';
    const ordersList = document.getElementById('available-orders-list');

    if (!initData) {
        console.error('Telegram initData is missing');
    }

    function formatDate(datetime) {
        const options = {
            day: '2-digit',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        return new Date(datetime).toLocaleString('en-US', options);
    }

    async function loadClientHistory() {
        try {
            const response = await fetch('/api/orders/client-history', {
                method: 'GET',
                headers: { 'X-Telegram-Init-Data': initData }
            });

            if (!response.ok) throw new Error('Failed to load history');

            const orders = await response.json();
            renderOrders(orders);
        } catch (err) {
            console.error('Error loading ride history:', err);
            if (ordersList) {
                ordersList.innerHTML = '<div class="error">Failed to load ride history. Please try again.</div>';
            }
        }
    }

    function renderOrders(orders) {
        if (!ordersList) return;
        ordersList.innerHTML = '';

        if (orders.length === 0) {
            ordersList.innerHTML = '<div class="empty">No rides found. Start your first journey!</div>';
            return;
        }

        orders.forEach(order => {
            const card = document.createElement('div');
            card.className = 'order-card';

            const dateFormatted = formatDate(order.createdAt || order.date);
            const status = (order.status || 'PENDING').toUpperCase();
            
         	// Calculate total including tip
            const priceTotal = (order.price || 0) + (order.bonusFare || 0);

         	// --- Price and Status Logic ---
            let priceStatusBlock = '';
            if (status === 'COMPLETED' || status === 'FINISHED') {
                const tipText = order.bonusFare > 0 
                    ? `<span class="bonus">(incl. tip ${order.bonusFare.toFixed(2)} )</span>` 
                    : '';
                
                priceStatusBlock = `
                    <div class="order-price">
                        <strong>Total:</strong> ${priceTotal.toFixed(2)} ${tipText}
                    </div>`;
            } else if (status === 'CANCELED' || status === 'CANCELLED') {
                priceStatusBlock = `<div class="order-price no-price">Trip cancelled</div>`;
            } else {
                priceStatusBlock = `<div class="order-price no-price">In progress...</div>`;
            }

         	// --- Driver Information (if assigned) ---
            const driverInfo = order.driver ? `
                <div class="order-car" style="font-size: 0.9em; color: #777; margin-bottom: 8px;">
                    ${order.driver.carColor} ${order.driver.carModel} â€¢ <strong>${order.driver.licensePlate}</strong>
                </div>` : '';

            card.innerHTML = `
                <div class="order-header">
                    <span class="order-date">${dateFormatted}</span>
                    <span class="order-status status-${status.toLowerCase()}">${status}</span>
                </div>
                ${driverInfo}
                <hr>
                <div class="order-address"><strong>From:</strong> ${order.startAddress}</div>
                <div class="order-address"><strong>To:</strong> ${order.endAddress}</div>
                ${order.notes ? `<div class="order-notes">ðŸ“Œ ${order.notes}</div>` : ''}
                ${priceStatusBlock}
            `;

            ordersList.appendChild(card);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        tg.ready();
        
     	// Standard Telegram Back Button behavior
        tg.BackButton.show();
        tg.BackButton.onClick(() => {
            window.location.href = `/index.html?initData=${encodeURIComponent(initData)}`;
        });

        loadClientHistory();
    });
</script>

</body>
</html>
