<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Ride History</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" th:href="@{/style.css}" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>
<body>

<div class="header">
    <!-- <button class="btn btn-additional" onclick="goBack()">‚Üê go back</button> -->
    <h1>Ride History</h1>
</div>

<div class="orders-container" id="available-orders-list">
    <div class="loading">Loading orders...</div>
</div>

<script>
const initData = Telegram.WebApp?.initData || Telegram.WebApp?.initDataUnsafe || '';
const ordersList = document.getElementById('available-orders-list');

if (!initData) {
    alert('–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram.');
}

function formatDate(datetime) {
    const options = {
        day: '2-digit',
        month: 'long',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    };
    return new Date(datetime).toLocaleString('en-EN', options);
}

async function loadAvailableOrders() {
    try {
        const response = await fetch('/api/orders/client-history', {
            method: 'GET',
            headers: {
                'X-Telegram-Init-Data': initData
            }
        });

        if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤');

        const orders = await response.json();
        renderOrders(orders);
    } catch (err) {
        console.error('Load available orders error:', err);
        ordersList.innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–∫–∞–∑–æ–≤</div>';
    }
}

function renderOrders(orders) {
    ordersList.innerHTML = '';

    if (orders.length === 0) {
        ordersList.innerHTML = '<div class="empty">No any orders yet.</div>';
        return;
    }

    orders.forEach(order => {
        const card = document.createElement('div');
        card.className = 'order-card';

        const dateFormatted = formatDate(order.createdAt || order.date || Date.now());

        const priceTotal = order.price + (order.bonusFare || 0);

        card.innerHTML = `
            <div class="order-header">
                <span class="order-date">${dateFormatted}</span>
                <span class="order-status">${order.status}</span>
            </div>
            ${order.driver ? `<div class="order-car">
                    ${order.driver.carModel} ${order.driver.carColor} ‚Ä¢ ${order.driver.licensePlate}
                    </div>` : ''}
            <hr>
            <div class="order-address"><strong>‚è§</strong> ${order.startAddress}</div>
            <div class="order-address"><strong>‚è§</strong> ${order.endAddress}</div>
            ${order.notes ? `<div class="order-notes">üìå ${order.notes}</div>` : ''}
            <div class="order-price">
                <strong>Total:</strong> ${priceTotal} 
                ${order.bonusFare ? `<span class="bonus">(including your tip: ${order.bonusFare})</span>` : ''}
            </div>
        `;

        ordersList.appendChild(card);
    });
}


function goBack() {
    window.location.href = `/index.html?initData=${encodeURIComponent(initData)}`;
}

document.addEventListener('DOMContentLoaded', () => {
    Telegram.WebApp.ready();
    
	// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "Back"
    Telegram.WebApp.BackButton.show();
 	// –ù–∞–∑–Ω–∞—á–∞–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
    Telegram.WebApp.BackButton.onClick(() => {
        window.location.href = `/index.html?initData=${encodeURIComponent(initData)}`;
    });
	
    loadAvailableOrders();
});
</script>

</body>
</html>
