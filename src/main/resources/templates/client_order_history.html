<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Ride History | Hop-in taxi app</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" th:href="@{/style.css}"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
</head>
<body>

<div class="header">
    <h1>Ride History</h1>
</div>

<div class="orders-container" id="available-orders-list">
    <div class="loading">Loading orders...</div>
</div>

<script>
    const initData = Telegram.WebApp?.initData || Telegram.WebApp?.initDataUnsafe || '';
    const ordersList = document.getElementById('available-orders-list');

    if (!initData) {
        alert('Error: Unable to retrieve Telegram data.');
    }

    function formatDate(datetime) {
        const options = {
            day: '2-digit',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        return new Date(datetime).toLocaleString('en-US', options);
    }

    async function loadAvailableOrders() {
        try {
            const response = await fetch('/api/orders/client-history', {
                method: 'GET',
                headers: {
                    'X-Telegram-Init-Data': initData
                }
            });

            if (!response.ok) throw new Error('Failed to load ride history.');

            const orders = await response.json();
            renderOrders(orders);
        } catch (err) {
            console.error('Error loading ride history:', err);
            ordersList.innerHTML = '<div class="error">Failed to load ride history.</div>';
        }
    }

    function renderOrders(orders) {
        ordersList.innerHTML = '';

        if (orders.length === 0) {
            ordersList.innerHTML = '<div class="empty">No rides yet.</div>';
            return;
        }

        orders.forEach(order => {
            const card = document.createElement('div');
            card.className = 'order-card';

            const dateFormatted = formatDate(order.createdAt || order.date || Date.now());
            const priceTotal = order.price + (order.bonusFare || 0);

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ –ø—Ä–∏–≤–æ–¥–∏–º –µ–≥–æ –∫ –≤–µ—Ä—Ö–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            const status = (order.status || '').toUpperCase();

            // --- –ë–ª–æ–∫ —Ü–µ–Ω—ã / —Å—Ç–∞—Ç—É—Å–∞ ---
            let priceStatusBlock = '';

            if (status === 'COMPLETED') {
                // 1. –î–ª—è COMPLETED: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–Ω—É—é —Ü–µ–Ω—É
                priceStatusBlock = `
                <div class="order-price">
                    <strong>Total:</strong> ${priceTotal}
                    ${order.bonusFare ? `<span class="bonus">(includes your tip: ${order.bonusFare})</span>` : ''}
                </div>
            `;
            } else if (status === 'CANCELED') {
                priceStatusBlock = `
                <div class="order-price no-price">
                    Trip cancelled
                </div>
            `;
            } else {
                priceStatusBlock = `
                <div class="order-price no-price">
                    In progress...
                </div>
            `;
            }

            card.innerHTML = `
            <div class="order-header">
                <span class="order-date">${dateFormatted}</span>
                <span class="order-status">${order.status || 'N/A'}</span>
            </div>
            ${order.driver ? `<div class="order-car">
                    ${order.driver.carModel} ${order.driver.carColor} ‚Ä¢ ${order.driver.licensePlate}
                    </div>` : ''}
            <hr>
            <div class="order-address"><strong>‚è§</strong> ${order.startAddress}</div>
            <div class="order-address"><strong>‚è§</strong> ${order.endAddress}</div>
            ${order.notes ? `<div class="order-notes">üìå ${order.notes}</div>` : ''}

            ${priceStatusBlock} `;

            ordersList.appendChild(card);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        Telegram.WebApp.ready();

        // Show the Telegram "Back" button
        Telegram.WebApp.BackButton.show();
        // Handle back button click
        Telegram.WebApp.BackButton.onClick(() => {
            window.location.href = `/index.html?initData=${encodeURIComponent(initData)}`;
        });

        loadAvailableOrders();
    });
</script>

</body>
</html>
