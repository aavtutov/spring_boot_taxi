<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Active Order | Hop-in taxi app</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
        }

        .top-buttons {
            position: absolute;
            top: 100px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            z-index: 10;
        }

        .btn-with-text {
            padding: 8px 14px;
            border: none;
            border-radius: 18px;
            background-color: #000;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.2s;
        }

        .btn-circle {
            background-color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            font-size: 20px;
            color: #007aff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* –ú–µ–Ω—é —Å–Ω–∏–∑—É */
        .update-menu {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 10px 10px 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 20;
        }

        .hidden {
            display: none !important;
        }

        .btn-menu {
            padding: 12px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        #btn-cancel-trip {
            background-color: white;
            color: red;

        }

    </style>

    <!-- Preload scripts -->
    <link rel="preload" href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js" as="script">
    <link rel="preload" href="https://telegram.org/js/telegram-web-app.js" as="script">

    <!-- Styles -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" media="print"
          onload="this.media='all'">
    <noscript>
        <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    </noscript>

    <!-- Scripts -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js" defer></script>
    <script src="https://telegram.org/js/telegram-web-app.js" defer></script>

</head>

<body>
<div th:if="${noActiveOrder}">
    <p></p>
</div>

<div th:if="${order != null}">
    <div id="map"></div>

<div class="top-buttons">
    <!-- <button class="btn-with-text" onclick="goBack()">‚Üê go back</button> -->
    <button class="btn-with-text" onclick="toggleMenu()">Update order</button>
</div>

    <div id="update-menu" class="update-menu hidden">
        <button id="btn-client-in-car" class="btn-menu hidden">–ö–ª–∏–µ–Ω—Ç –≤ –º–∞—à–∏–Ω–µ</button>
        <button id="btn-complete-trip" class="btn-menu">–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
        <button id="btn-cancel-trip" class="btn-menu">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
    </div>
</div>

<script th:inline="javascript">
const initData = Telegram.WebApp?.initData || Telegram.WebApp?.initDataUnsafe || '';
const order = /*[[${order}]]*/ null;
const noActiveOrder = /*[[${noActiveOrder}]]*/ false;



if (!initData) {
    alert('–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ Telegram.');
    throw new Error('No initData');
}

// ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è order.*
if (!order || noActiveOrder) {
    alert('–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞');
    window.location.href = '/driver/dashboard?initData=' + encodeURIComponent(initData);
} else {
    Telegram.WebApp.ready();
    
	// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "Back"
    Telegram.WebApp.BackButton.show();
 	// –ù–∞–∑–Ω–∞—á–∞–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
    Telegram.WebApp.BackButton.onClick(() => {
    	window.location.href = '/driver/dashboard?initData=' + encodeURIComponent(initData);
    });

    const startLat = parseFloat(order.startLatitude);
    const startLng = parseFloat(order.startLongitude);
    const endLat = parseFloat(order.endLatitude);
    const endLng = parseFloat(order.endLongitude);

    const mapboxToken = 'pk.eyJ1IjoibW90ZWhhbG9nZW4wayIsImEiOiJjbWdmOTB3MmswNWpoMmlzYzBpYW5sY3QwIn0.SmxMkvM66aGaoCJs45YX3g';
    mapboxgl.accessToken = mapboxToken;

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [startLng, startLat],
        zoom: 12
    });

    new mapboxgl.Marker({ color: 'black' })
        .setLngLat([startLng, startLat])
        .setPopup(new mapboxgl.Popup().setText("–ù–∞—á–∞–ª–æ –ø–æ–µ–∑–¥–∫–∏"))
        .addTo(map);

    const flagMarker = document.createElement('div');
    flagMarker.textContent = 'üèÅ';
    flagMarker.style.fontSize = '24px';
    
    new mapboxgl.Marker(flagMarker)
    .setLngLat([endLng, endLat])
    .setPopup(new mapboxgl.Popup().setText("–§–∏–Ω–∏—à"))
    .addTo(map);

    const route = {
        type: 'Feature',
        geometry: {
            type: 'LineString',
            coordinates: [
                [startLng, startLat],
                [endLng, endLat]
            ]
        }
    };

    async function getRoute(start, end) {
        const query = await fetch(
            `https://api.mapbox.com/directions/v5/mapbox/driving/${start[0]},${start[1]};${end[0]},${end[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`
        );
        const data = await query.json();
        return data.routes[0].geometry;
    }
    
    map.on('load', async () => {
        const routeGeo = await getRoute([startLng, startLat], [endLng, endLat]);

        map.addSource('route', {
            type: 'geojson',
            data: {
                type: 'Feature',
                geometry: routeGeo
            }
        });

        map.addLayer({
            id: 'route',
            type: 'line',
            source: 'route',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: {
                'line-color': '#000',
                'line-width': 5
            }
        });

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥—Ä–∞–Ω–∏—Ü –º–∞—Ä—à—Ä—É—Ç–∞
        const bounds = new mapboxgl.LngLatBounds();
        routeGeo.coordinates.forEach(coord => bounds.extend(coord));
        map.fitBounds(bounds, { padding: 110 });
    });

    function goBack() {
        window.location.href = '/driver/dashboard?initData=' + encodeURIComponent(initData);
    }

    function toggleMenu() {
        document.getElementById('update-menu')?.classList.toggle('hidden');
    }

    function updateOrderStatus(action) {
        const body = { action };
        
        fetch(`/api/orders/${order.id}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-Telegram-Init-Data': initData
            },
            body: JSON.stringify(body)
        })
        .then(res => {
            if (!res.ok) return res.text().then(t => { throw new Error(t); });
            return res.json();
        })
        .then(updatedOrder => {
            alert('–£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
            location.reload();
        })
        .catch(err => {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞:', err);
            alert('–û—à–∏–±–∫–∞: ' + err.message);
        });
    }
    
    
    const HEARTBEAT_INTERVAL = 30000;
    let heartbeatTimer = null;
    
    
    async function sendHeartbeat() {
        try {
            await fetch('/api/drivers/heartbeat', {
                method: 'POST',
                headers: {
                    'X-Telegram-Init-Data': initData
                }
            });
        } catch (error) {
            console.error('Heartbeat error:', error);
            stopHeartbeat();
        }
    }
    
    function startHeartbeat() {
        if (heartbeatTimer) return;
        sendHeartbeat();
        heartbeatTimer = setInterval(sendHeartbeat, HEARTBEAT_INTERVAL);
    }

    function stopHeartbeat() {
        clearInterval(heartbeatTimer);
        heartbeatTimer = null;
    }
    
    

    document.addEventListener('DOMContentLoaded', () => {
    	startHeartbeat();
        const btnClientInCar = document.getElementById('btn-client-in-car');
        const btnComplete = document.getElementById('btn-complete-trip');
        const btnCancel = document.getElementById('btn-cancel-trip');

        if (order.status === 'ACCEPTED' && btnClientInCar) {
            btnClientInCar.classList.remove('hidden');
            btnClientInCar.addEventListener('click', () => {
                const confirmed = confirm('–ö–ª–∏–µ–Ω—Ç —É–∂–µ –≤ –º–∞—à–∏–Ω–µ –∏ –Ω–∞—á–∏–Ω–∞–µ–º –ø–æ–µ–∑–¥–∫—É?');
                if (confirmed) {
                    updateOrderStatus('START_TRIP');
                }
            });
        }

        btnComplete?.addEventListener('click', () => {
        	const confirmed = confirm('–ó–∞–≤–µ—Ä—à–∏—Ç—å –ø–æ–µ–∑–¥–∫—É?');
            if (confirmed) {
            	updateOrderStatus('COMPLETE');
            }
        });

        btnCancel?.addEventListener('click', () => {
        	const confirmed = confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –ø–æ–µ–∑–¥–∫—É?');
            if (confirmed) {
                updateOrderStatus('CANCEL_BY_DRIVER');
            }
        });
    });
}
</script>
</body>

</html>

