<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Active Order | Hop-in taxi app</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
        }

        .top-buttons {
            position: absolute;
            top: calc(env(safe-area-inset-top, 0px) + 45px);
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: flex-end;
            z-index: 10;
        }

        .btn-with-text {
            padding: 8px 14px;
            border: none;
            border-radius: 18px;
            background-color: #000;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.2s;
        }

        .btn-circle {
            background-color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            font-size: 20px;
            color: #007aff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .update-menu {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 15px calc(env(safe-area-inset-bottom, 0px) + 15px);
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 20;
            border-radius: 20px 20px 0 0;
        }

        .hidden {
            display: none !important;
        }

        .btn-menu {
            padding: 12px;
            background-color: #007aff;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        #btn-cancel-trip {
            background-color: white;
            color: red;

        }

    </style>
    <!-- Telegram -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Mapbox -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
</head>

<body>
<div th:if="${noActiveOrder}">
    <p></p>
</div>

<div th:if="${order != null}">
    <div id="map"></div>

    <div class="top-buttons">
        <button class="btn-with-text" onclick="toggleMenu()">Update order</button>
    </div>

    <div id="update-menu" class="update-menu hidden">
        <button id="btn-driver-arrived" class="btn-menu hidden">I've arrived</button>
        <button id="btn-complete-trip" class="btn-menu">Complete trip</button>
        <button id="btn-cancel-trip" class="btn-menu">Cancel trip</button>
    </div>
</div>

<script th:inline="javascript">
    // --- Data Initialization ---
    const initData = Telegram.WebApp?.initData || Telegram.WebApp?.initDataUnsafe || '';
    const order = /*[[${order}]]*/ null;
    const noActiveOrder = /*[[${noActiveOrder}]]*/ false;
    const tg = Telegram.WebApp;
    const ORDER_POLL_INTERVAL = 5000;
    let orderStatusPollTimer = null;
    

    if (!initData) {
        tg.showAlert('Error: Unable to retrieve Telegram data.');
        throw new Error('No initData');
    }

    // Redirect if no order is found
    if (!order || noActiveOrder) {
        tg.showAlert('You have no active orders.', () => {
            window.location.href = '/driver/dashboard?initData=' + encodeURIComponent(initData);
        });
    } else {
        tg.ready();

        // --- Navigation Setup ---
        tg.BackButton.show();
        tg.BackButton.onClick(() => {
            window.location.href = '/driver/dashboard?initData=' + encodeURIComponent(initData);
        });

        // --- Map Configuration ---
        const startLat = parseFloat(order.startLatitude);
        const startLng = parseFloat(order.startLongitude);
        const endLat = parseFloat(order.endLatitude);
        const endLng = parseFloat(order.endLongitude);
        
        const startPopupContent = `
            ${order.startAddress}
            ${order.notes ? `<br><br>ðŸ“Œ <em>Note: ${order.notes}</em>` : ''}
        `;
        
         const endPopupContent = `
            ${order.endAddress}
            ${order.notes ? `<br><br>ðŸ“Œ <em>Note: ${order.notes}</em>` : ''}
        `;

        mapboxgl.accessToken = 'pk.eyJ1IjoibW90ZWhhbG9nZW4wayIsImEiOiJjbWpocDFpdmsxOW91M2NzNmZuc2kza3BjIn0.QJgCGsTJFtZGcJyxgQlDyA';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/navigation-day-v1',
            center: [startLng, startLat],
            zoom: 12
        });

        // Add Markers
        new mapboxgl.Marker({color: 'black'})
            .setLngLat([startLng, startLat])
            .setPopup(new mapboxgl.Popup({ offset: 25 })
            .setHTML(startPopupContent))
            .addTo(map);

        const flagMarker = document.createElement('div');
        flagMarker.textContent = 'ðŸ';
        flagMarker.style.fontSize = '24px';

        new mapboxgl.Marker(flagMarker)
            .setLngLat([endLng, endLat])
            .setPopup(new mapboxgl.Popup({ offset: 25 })
            .setHTML(endPopupContent))
            .addTo(map);

        // --- Route Drawing ---
        async function getRoute(start, end) {
            const query = await fetch(
                `https://api.mapbox.com/directions/v5/mapbox/driving/${start[0]},${start[1]};${end[0]},${end[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`
            );
            const data = await query.json();
            return data.routes[0].geometry;
        }

        map.on('load', async () => {
            const routeGeo = await getRoute([startLng, startLat], [endLng, endLat]);

            map.addSource('route', {
                type: 'geojson',
                data: { type: 'Feature', geometry: routeGeo }
            });

            map.addLayer({
                id: 'route',
                type: 'line',
                source: 'route',
                layout: {'line-join': 'round', 'line-cap': 'round'},
                paint: { 'line-color': '#000', 'line-width': 5 }
            });

            const bounds = new mapboxgl.LngLatBounds();
            routeGeo.coordinates.forEach(coord => bounds.extend(coord));
            map.fitBounds(bounds, { 
    		    padding: {
    		        top: 200,
    		        bottom: 100,
    		        left: 50,
    		        right: 50
    		    },
    		    duration: 2000
    		});
            
            
        });
        
        function toggleMenu() {
        	document.getElementById('update-menu')?.classList.toggle('hidden');
    	}

        // --- Order Status Management ---
        /**
         * Sends status updates to the server and handles the UI response.
         */
        function updateOrderStatus(action) {
            fetch(`/api/orders/${order.id}`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Telegram-Init-Data': initData
                },
                body: JSON.stringify({action})
            })
            .then(res => {
                if (!res.ok) return res.text().then(t => { throw new Error(t); });
                return res.json();
            })
            .then(updatedOrder => {
                if (action === 'COMPLETE') {
                	
                	if(tg.HapticFeedback) {
                		tg.HapticFeedback.notificationOccurred('success');
                	}
                	
                    const total = updatedOrder.totalPrice || 0;
                    const tip = updatedOrder.bonusFare || 0;
                    const fare = total - tip;

                    tg.showAlert(
                    		`Trip Completed! ðŸ\n\n` +
                    	    `Fare: ${fare.toFixed(2)}\n` +
                    	    `Tip: ${tip}\n` +
                    	    `-------------------\n` +
                    	    `Total: ${total.toFixed(2)}`, 
                        () => {
                            window.location.href = '/driver/dashboard?initData=' + encodeURIComponent(initData);
                        }
                    );
                } 
                else if (action === 'CANCEL_BY_DRIVER') {
                	
                	if (tg.HapticFeedback) {
                        tg.HapticFeedback.notificationOccurred('warning');
                    }
                	
                    tg.showAlert('Order cancelled.', () => {
                        window.location.href = '/driver/dashboard?initData=' + encodeURIComponent(initData);
                    });
                }
                else {
                	
                	if (tg.HapticFeedback) {
                        tg.HapticFeedback.impactOccurred('medium');
                    }
                	
                    location.reload(); // For START_TRIP
                }
            })
            .catch(err => {
                console.error('Update error:', err);
                
                if (tg.HapticFeedback) {
                    tg.HapticFeedback.notificationOccurred('error');
                }
                
                tg.showAlert('Error: ' + err.message);
            });
        }

        // --- Driver Presence (Heartbeat) ---
        const HEARTBEAT_INTERVAL = 30000;
        let heartbeatTimer = null;

        async function sendHeartbeat() {
            try {
                await fetch('/api/drivers/heartbeat', {
                    method: 'POST',
                    headers: { 'X-Telegram-Init-Data': initData }
                });
            } catch (error) {
                console.error('Heartbeat error:', error);
                stopHeartbeat();
            }
        }
        
        
        function startOrderStatusPolling() {
            if (orderStatusPollTimer) return;
            
            orderStatusPollTimer = setInterval(async () => {
                try {
                    const response = await fetch(`/api/orders/${order.id}`, {
                        method: 'GET',
                        headers: { 'X-Telegram-Init-Data': initData }
                    });

                    if (response.status === 404 || response.status === 204) {
                        handleOrderTerminated('Order no longer exists.');
                        return;
                    }

                    const updatedOrder = await response.json();

                    // If CANCELED or COMPLETED elsewhere
                    const terminalStatuses = ['CANCELED', 'COMPLETED'];
                    if (terminalStatuses.includes(updatedOrder.status) && updatedOrder.status !== order.status) {
                        let message = 'Order was cancelled by the client.';
                        if (updatedOrder.status === 'COMPLETED') message = 'Order was marked as completed.';
                        
                        handleOrderTerminated(message);
                    }
                } catch (err) {
                    console.error('Polling error:', err);
                }
            }, ORDER_POLL_INTERVAL);
        }

        function handleOrderTerminated(message) {
            stopOrderStatusPolling();
            if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('warning');
            
            tg.showAlert(message, () => {
                window.location.href = '/driver/dashboard?initData=' + encodeURIComponent(initData);
            });
        }

        function stopOrderStatusPolling() {
            clearInterval(orderStatusPollTimer);
            orderStatusPollTimer = null;
        }
        

        function startHeartbeat() {
            if (heartbeatTimer) return;
            sendHeartbeat();
            heartbeatTimer = setInterval(sendHeartbeat, HEARTBEAT_INTERVAL);
        }

        function stopHeartbeat() {
            clearInterval(heartbeatTimer);
            heartbeatTimer = null;
        }
        
        
     	// --- Activity Monitoring ---
        /**
         * Stops/Starts all timers when the user switches apps or minimizes Telegram.
         */
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopHeartbeat();
                stopOrderStatusPolling();
            } else {
                startHeartbeat();
                startOrderStatusPolling();
            }
        });
        

        // --- UI Logic & Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            startHeartbeat();
            startOrderStatusPolling();
            const btnDriverArrived = document.getElementById('btn-driver-arrived');
            const btnComplete = document.getElementById('btn-complete-trip');
            const btnCancel = document.getElementById('btn-cancel-trip');

            btnDriverArrived?.classList.add('hidden');
            btnComplete?.classList.add('hidden');
            
            // 1. Order Accepted - Waiting for Passenger
            if (order.status === 'ACCEPTED') {
            	btnDriverArrived?.classList.remove('hidden');
            	btnDriverArrived?.addEventListener('click', () => {
                    tg.showConfirm('Confirm arrival?', (ok) => {
                        if (ok) updateOrderStatus('START_TRIP');
                    });
                });
            }
            // 2. Trip in Progress
            else if (order.status === 'IN_PROGRESS') {
                btnComplete?.classList.remove('hidden');
                btnComplete?.addEventListener('click', () => {
                    tg.showConfirm('Are you sure you want to complete this trip?', (ok) => {
                        if (ok) updateOrderStatus('COMPLETE');
                    });
                });
            }
            
            btnCancel?.addEventListener('click', () => {
                tg.showConfirm('Are you sure you want to cancel this trip?', (ok) => {
                    if (ok) updateOrderStatus('CANCEL_BY_DRIVER');
                });
            });
        });
    }
</script>
</body>

</html>

